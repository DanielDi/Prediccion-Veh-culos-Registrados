---
title: "Agrupamiento-Universidades"
author: "Brayan M. Ortiz Fajardo, Juan Felipe Peña Tamayo, Thalea Marina Hesse, Juan Sebastián Falcon, Daniel Espinal Mosquera"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("readxl")
library(dplyr)
library(stats)
library('simts')
library('tseries')
library("corrplot")
library(forecast)
library("Metrics")
library('yardstick')
```
# Lectura de los datos
Los datos corresponden a la suma de los 365 días que tienen los años 2013, 2014, 2015 y 2017 sumados a los 366 días que tiene los años 2012 y 2016. En total, se tienen 2192 datos.
```{r include=FALSE}
datos <- read_excel("registros_entrenamiento_festivos.xlsx")
```

## Procesamiento de los datos

Los datos originales contienen, únicamente, una variable: La fecha de registro. Para buscar un óptimo análisis, se decidió generar 4 variables nuevas con base a la fecha de registro, estas son: día de la semana, número de día del mes, mes y año.
Además, se generó una variable binaria llamada "festivo" para conocer si un día del año es una festividad en Colombia, pues estos días suelen presentar valores atípicos en las unidades registradas y esta variable aporta esta información.

```{r, echo=FALSE}
datos$Fecha <- as.Date(datos$Fecha)
datos$Ts <- as.numeric(datos$Fecha)
datos$Dia_semana <- weekdays(datos$Fecha)

datos$Dia <- format(datos$Fecha, "%d")
datos$Mes <- as.factor(as.numeric(format(datos$Fecha, "%m")))
datos$Anio <- format(datos$Fecha, "%y")
datos$Wday <- lubridate::wday(datos$Fecha, week_start = 1)

datos <- datos[-1]
```

```{r}
plot(datos$Ts, datos$Unidades)
```
Cosas interesantes:
En semana santa (aprox por semanas de abril) los días jueves, viernes, sábado y domingo suelen haber pocos registros en todos los años.
Los días festivos entre semana suelen generar datos atípicos en los días anteriores o posteriores (además de que el día festivo como tal también suele ser atípico)
datos <- datos[-1]

```{r}
# Se convertien a numéricos todas las variables excepto el día de la semana
datos[,c(1,2,4,5,6)] <- sapply(datos[,c(1,2,4,5,6)], as.numeric)

# Se dive la variable día de la semana en n variables binarias
dummy <- as.data.frame(model.matrix(~ datos$Dia_semana - 1))
colnames(dummy) <- c("domingo", "lunes", "martes", "miercoles", "jueves", "viernes", "sabado")

# Se unen los dos dataframes
datos <- subset(datos, select = c(-Dia_semana))
datos <- cbind(datos, dummy)

datos[, c(2:12)] <- as.data.frame(scale(datos[, c(2:12)], center = TRUE, scale = TRUE))
```

# Separación de datos en entrenamiento y validación
De los 2192 se plantea usar apróximadamente el 75% de los datos para entrenamiento. Teniendo esto en cuenta, tenemos 1644 días, lo cuál equivale a apróximadamente 4.5 años; con el fin de lograr un adecuado entrenamiento para todos los días de cada año, se extenderá este conjunto de entrenamiento hasta los 5 años, es decir, los días entre 01-01-2012 hasta 31-12-2016 y utilizar los días correspondientes al año 2017 como validación.

```{r, echo=FALSE}
df_train_ts <- datos[datos$Anio != "17", ]
df_train_ts <- df_train_ts[df_train_ts$Festivo ==0, ]
df_train_ts <- df_train_ts[df_train_ts$Wday !=7, ]
df_val <- datos[datos$Anio == "17", ]
datos1 <- sample(2, nrow(datos),
                   replace = T,
                   prob = c(0.75, 0.25))

df_train <- datos[datos1 == 1,]
df_test <- datos[datos1 == 2,]
```

# Análisis estadístico

```{r, echo=FALSE}
corr_train = cor(df_train)
corrplot(corr_train)
```

# Modelo de regresión lineal

```{r, echo=FALSE}
glm_ <- lm(df_train$Unidades ~ ., data = df_train)
summary(lm_)
```
   
```{r, echo=FALSE}
df_val$Y_predict <- predict(glm_, newdata=df_val)
```
## Modelo time series
```{r}
t_modelo <- lm(Unidades ~ Ts,df_train_ts)
T_pred <- predict(t_modelo, df_train_ts)
df_train_ts$sin_trend <- df_train_ts$Unidades - T_pred

plot(df_train_ts$Ts, df_train_ts$Unidades)
lines(df_train_ts$Ts, T_pred, type="l", col = "red")
plot(df_train_ts$Ts, df_train_ts$sin_trend)
```
```{r}

seasonM <- setRefClass("seasonM", fields = list(means = "data.frame"), methods = list(
                       predict = function(input)
                       {
                           return (means$Mean[as.numeric(input$Mes)])
                       }))

mes_means <- df_train_ts %>% group_by(Mes) %>% summarize(Mean = mean(sin_trend))
s1_modelo <- new('seasonM', means = mes_means)
df_train_ts$sin_season1 <- df_train_ts$sin_trend - s1_modelo$predict(df_train_ts)



plot(df_train_ts$Ts, df_train_ts$sin_season1)
plot(mes_means)
```
```{r}
seasonW <- setRefClass("seasonW", fields = list(means = "data.frame"), methods = list(
                       predict = function(input)
                       {
                           return (means$Mean[input$Wday])
                       }))

dia_means <- df_train_ts %>% group_by(Wday) %>% summarize(Mean = mean(sin_season1))
s2_modelo <- new('seasonW', means = dia_means)
df_train_ts$sin_season2 <- df_train_ts$sin_season1 - s2_modelo$predict(df_train_ts)

plot(df_train_ts$Ts, df_train_ts$sin_season2)
plot(dia_means)
```

```{r}
seasonD <- setRefClass("seasonD", fields = list(means = "data.frame"), methods = list(
                       predict = function(input)
                       {
                           return (means$Mean[as.numeric(input$Dia)])
                       }))

dia_means <- df_train_ts %>% group_by(Dia) %>% summarize(Mean = mean(sin_season2))
s3_modelo <- new('seasonD', means = dia_means)
df_train_ts$sin_season3 <- df_train_ts$sin_season2 - s3_modelo$predict(df_train_ts)

plot(df_train_ts$Ts, df_train_ts$sin_season3)
plot(dia_means)
```

```{r}
acf(df_train_ts$sin_season3)
m = auto_corr(df_train_ts$sin_season3, pacf = TRUE)
plot(m)
```

```{r}
R_modelo <-  arima(df_train_ts$sin_season3, order=c(6,0,5))
i <- setClass('Arima')

```
Predición final:
```{r}
 # predicion para el an~o después

model_TS <- setRefClass("model_TS", fields = list(t = "lm", s1 = "seasonM", s2= "seasonW", s3 = "seasonD", r = 'Arima'), methods = list(
                       predict_ese = function(data)
                       {
                         data_festivo <- data[as.vector(data$Festivo == 1) | as.vector(data$Wday == 7),]
                         data_trabajo <- data[as.vector(data$Festivo == 0) & as.vector(data$Wday != 7),]
                         pred_T <- predict(t, data_trabajo)
                         pred_S1 <- s1$predict(data_trabajo)
                         pred_S2 <- s2$predict(data_trabajo)
                         pred_S3 <- s3$predict(data_trabajo)
                         pred_R <- predict(r, n.ahead = length(data_trabajo$Ts))
                         data_trabajo$pred <- pred_T + pred_S1 + pred_S2 + pred_S3 + as.vector(pred_R$pred)
                         data_festivo$pred<-0
                         return (rbind(data_trabajo, data_festivo ))
                       }))

modelo_final <- new('model_TS', t = t_modelo, s1 = s1_modelo, s2 = s2_modelo, s3 = s3_modelo, r= R_modelo)
predict_final = modelo_final$predict_ese(df_val)
plot(predict_final$Ts, predict_final$pred)
points(df_val$Ts, df_val$Unidades, col = "red")
```

```{r}

lm__mae <- mae(predict_final$Unidades, predict_final$pred)
lm__mse <- mse(predict_final$Unidades, predict_final$pred)
lm__rmse <- rmse(predict_final$Unidades, predict_final$pred)
lm__rsq <- rsq(predict_final, Unidades, pred)
paste("Error absoluto medio (MAE): ", lm__mae)
paste("Error medio cuadrado (MSE): ", lm__mse)
paste("Error cuadrático medio (RMSE): ", lm__rmse)
paste("Error cuadrático medio (R²): ", lm__rsq$.estimate)
```